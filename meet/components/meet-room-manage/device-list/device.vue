<template>
  <div>
    <section class="m-main">
      <!--导航-->
      <div class="m-breadcrumb">
        <zl-breadcrumb title="设备信息" :item="breadcrumbItem"></zl-breadcrumb>
      </div>
      <div class="h-table-title">
        <h2>设备信息</h2>
        <p class="f-color-red">（*为必填项，请检查后提交！)</p>
      </div>
      <!-- 表单正文 -->
      <div class="h-tab-content" style="padding-bottom: 20px;">
        <el-form ref="ruleForm" :model="ruleForm" :rules="rules">
          <table class="h-table-info h-table-info-meet">
            <tr>
              <th width="10%"><i class="f-color-red">*</i>编号</th>
              <td width="40%">
                <el-form-item prop="equipNo" :rules="{required: true, message: '设备编号不能为空', trigger: 'change'}">
                  <el-input placeholder="请输入编号，最多20个字符" v-model="ruleForm.equipNo"></el-input>
                </el-form-item>
              </td>
              <th width="10%"><i class="f-color-red">*</i>设备信息</th>
              <td width="40%">
                <el-form-item prop="equipName" :rules="{required: true, message: '设备名称不能为空', trigger: 'change'}">
                  <el-input placeholder="请输入设备名称，最多20个字符" v-model="ruleForm.equipName"></el-input>
                </el-form-item>
              </td>
            </tr>
            <tr>
              <th><i class="f-color-red">*</i>型号</th>
              <td>
                <el-form-item prop="equipModel" :rules="{required: true, message: '设备型号不能为空', trigger: 'change'}">
                  <el-input placeholder="请输入设备型号，最多20个字符" v-model="ruleForm.equipModel"></el-input>
                </el-form-item>
              </td>
              <th><i class="f-color-red">*</i>品牌</th>
              <td>
                <el-form-item prop="equipBrand" :rules="{required: true, message: '品牌不能为空', trigger: 'change'}">
                  <el-input placeholder="请输入品牌，最多20个字符" v-model="ruleForm.equipBrand"></el-input>
                </el-form-item>
              </td>
            </tr>
            <tr>
              <th><i class="f-color-red">*</i>价格</th>
              <td>
                <el-form-item prop="singlePrice">
                  <el-input placeholder="请输入价格" v-model="ruleForm.singlePrice">
                    <template slot="append">元</template>
                  </el-input>
                </el-form-item>
              </td>
              <th><i class="f-color-red">*</i>购买时间</th>
              <td>
                <el-form-item prop="buyTime" :rules="{required: true, message: '购买时间不能为空', trigger: 'change'}">
                  <el-date-picker style="width:100%;" v-model="ruleForm.buyTime" type="date" placeholder="请选择购买时间"></el-date-picker>
                </el-form-item>
              </td>
            </tr>
            <tr>
              <th><i class="f-color-red">*</i>使用年限</th>
              <td>
                <el-form-item prop="eqpUseYears">
                  <el-input placeholder="请输入使用年限" v-model="ruleForm.eqpUseYears">
                    <template slot="append">年</template>
                  </el-input>
                </el-form-item>
              </td>
              <th>来源</th>
              <td>
                <el-form-item>
                  <el-input placeholder="请输入设备来源" v-model="ruleForm.source"></el-input>
                </el-form-item>
              </td>
            </tr>
            <tr>
              <th><i class="f-color-red">*</i>设备状态</th>
              <td colspan="3">
                <el-form-item prop="status" :rules="{required: true, message: '设备状态不能为空', trigger: 'change'}">
                  <el-radio-group placeholder="请输入设备状态" v-model="ruleForm.status">
                    <el-radio :label="1">使用中</el-radio>
                    <el-radio :label="2">报废</el-radio>
                    <el-radio :label="3">空闲</el-radio>
                  </el-radio-group>
                </el-form-item>
              </td>
            </tr>
            <tr>
              <th>备注</th>
              <td colspan="3">
                <el-form-item>
                  <el-input type="textarea" v-model="ruleForm.remark" placeholder="请输入备注，不超过200字" :maxlength="200"></el-input>
                </el-form-item>
                <div class="f-text-right">{{ruleForm.remark.length}}/200</div>
              </td>
            </tr>
          </table>
          <div class="f-text-center" style="margin-top: 20px;">
            <el-button class="u-submit-btn cancel-btn" @click="$router.go(-1)">返回</el-button>
            <el-button class="u-submit-btn submit-btn" @click="submitClick" :loading="loading">确定</el-button>
          </div>
        </el-form>
      </div>
    </section>
    <zl-prompt v-model="YPromptShow" :isBol="isBol" :message="message" @click="YPromptClick"></zl-prompt>
  </div>
</template>

<script>
export default {
  data() {
    let singlePrice = (rule, value, callback) => {
      if (!value) {
        callback(new Error('价格不能为空'))
      } else if (!/^(\d|([1-9]\d+))(\.\d{1,2})?$/.test(value)) {
        callback(new Error('价格只能为最多两位小数的有效数字'))
      } else if (value > 100000000) {
        callback(new Error('价格不能大于一亿元'))
      } else {
        callback()
      }
    };
    let eqpUseYears = (rule, value, callback) => {
      if (!value) {
        callback(new Error('使用年限不能为空'))
      } else if (!/^(\d|([1-9]\d+))(\.\d{1,2})?$/.test(value)) {
        callback(new Error('使用年限只能是整数'))
      } else if (value > 1000) {
        callback(new Error('使用年限不能大于一千年'))
      } else {
        callback()
      }
    };
    return {
      breadcrumbItem: [],
      YPromptShow: false,
      message: '',
      isBol: false,
      isHasImg: false,
      isHasCover: false,
      loading: false,
      rules: {
        singlePrice: [
          { validator: singlePrice, trigger: 'change' }
        ],
        eqpUseYears: [
          { validator: eqpUseYears, trigger: 'change' }
        ]
      },
      ruleForm: {
        id: '', // 会议室设备id
        equipNo: '', // 设备编号
        equipName: '', // 设备名称
        equipModel: '', // 设备型号
        equipBrand: '', // 设备品牌
        singlePrice: '', // 单价
        buyTime: '', // 购买时间
        expireDate: '', // 购买时间
        remark: '', // 备注
        eqpUseYears: '', // 使用年限
        source: '', // 设备来源
        organId: '', // 所属单位id
        usePlace: '', // 设备使用地
        status: 1,  // 设备状态
      },
      equipId: '',
    }
  },
  activated() {
    this.breadcrumbItem = ['会议室管理', '设备信息', '新增'];
    if (this.$route.params.type == 'edit') {
      this.breadcrumbItem = ['会议室管理', '设备信息', '修改'];
      this.getEditDetail();
    }
  },
  deactivated() {
    this.ruleForm.id = ''; // 会议室设备id
    this.ruleForm.equipNo = ''; // 设备编号
    this.ruleForm.equipName = ''; // 设备名称
    this.ruleForm.equipModel = ''; // 设备型号
    this.ruleForm.equipBrand = ''; // 设备品牌
    this.ruleForm.singlePrice = ''; // 单价
    this.ruleForm.buyTime = ''; // 购买时间
    this.ruleForm.remark = ''; // 备注
    this.ruleForm.eqpUseYears = ''; // 使用年限
    this.ruleForm.source = ''; // 设备来源
    this.ruleForm.status = 0; // 设备状态
  },
  methods: {
    getEditDetail() {
      let params = {
        id: this.$route.query.equipId
      }
      this.$axiosGet(API.equipInfo_toUpdateEquip, params).then(res => {
        if (res.status === 200) {
          this.ruleForm.id = res.data.id; // 会议室设备id
          this.ruleForm.equipNo = res.data.equipNo; // 设备编号
          this.ruleForm.equipName = res.data.equipName; // 设备名称
          this.ruleForm.equipModel = res.data.equipModel; // 设备型号
          this.ruleForm.equipBrand = res.data.equipBrand; // 设备品牌
          this.ruleForm.singlePrice = res.data.singlePrice; // 单价
          this.ruleForm.buyTime = new Date(res.data.buyTime); // 购买时间
          this.ruleForm.remark = res.data.remark; // 备注
          this.ruleForm.eqpUseYears = res.data.eqpUseYears; // 使用年限
          this.ruleForm.source = res.data.source; // 设备来源
          this.ruleForm.status = res.data.status; // 设备状态
          this.ruleForm.organId = res.data.organId;
          this.ruleForm.usePlace = res.data.usePlace;
        }
      })
    },
    // 提交
    submitClick() {
      this.$refs.ruleForm.validate((valid) => {
        if (valid && !this.isHasImg && !this.isHasCover) {
          let params = {
            equipNo: this.ruleForm.equipNo, // 设备编号
            equipName: this.ruleForm.equipName, // 设备名称
            equipModel: this.ruleForm.equipModel, // 设备型号
            equipBrand: this.ruleForm.equipBrand, // 设备品牌
            singlePrice: this.ruleForm.singlePrice, // 单价
            buyTime: DATE.dateReturnYMD(this.ruleForm.buyTime), // 购买时间
            expireDate: this.ruleForm.expireDate, // 到期时间
            remark: this.ruleForm.remark, // 备注
            eqpUseYears: this.ruleForm.eqpUseYears, // 使用年限
            source: this.ruleForm.source, // 设备来源
            status: this.ruleForm.status, // 设备状态
            organId: this.ruleForm.organId, // 所属单位id
            usePlace: this.ruleForm.usePlace, // 设备使用地
          }
          let url = '';
          if (this.$route.params.type == 'edit') {
            this.$set(params, 'id', this.$route.query.equipId);
            url = API.equipInfo_doUpdateEquip;
          } else {
            url = API.equipInfo_createEquip;
          }
          this.$axiosJsonPost(url, params).then(res => {
            if (res.status === 200) {
              this.isBol = true;
            } else {
              this.isBol = false;
            }
            this.loading = false;
            this.YPromptShow = true;
            this.message = res.message;
          }).catch(error => {
          })
        }
      })
    },
    // 操作成功弹出框回调方法
    YPromptClick() {
      if (this.isBol) {
        this.$router.push({ path: '/meet-room-manage/device-list' })
      }
    }
  }
}
</script>

<style>
</style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                